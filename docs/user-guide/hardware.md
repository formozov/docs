# Acquisition board

![Acquisition board](../media/board_photo.jpg)

The pyPhotometry acquisition board uses a [Micropython](https://micropython.org/) microcontroller to acquire two digital and two analog signals, and to generate analog control signals for two built in LED driver circuits.  The acquisition board draws power from the Micropython's USB connector and requires no additional power supply.

## Safety

To prevent short circuits due to contact with metal objects, the board should be securely mounted using M3 bolts and insulating spacers.  The mounting holes on the acquisition board have a 50 x 75mm spacing so the board can be mounted directly on a Thorlabs metric optical breadboard using M6 to M3 thread adaptors.

Though the LED drivers are relatively low power, care should be taken to avoid shining light directly into the eye.  This is particularly important with LEDs whose wavelength lies outside the visible spectrum.

## Analog inputs

The two BNC analog inputs `SIGNAL 1` and `SIGNAL 2` receive fluorescence signals as analog voltages from the photodetectors.  The signals pass through an RC lowpass filter with a cuttoff frequency of 10KHz and then are read by the Micropython board's analog to digital converters (ADCs).  The Micropython ADCs have a 0 - 3.3V input range.  As the ADC pins are not 5V tolerant, clamp diodes to the 3.3V rail are used to prevent damage if the signal rises above 3.3V. [Oversampling](https://www.silabs.com/documents/public/application-notes/an118.pdf) is used to increace the 12-bit resolution of the ADCs to 15 bits - i.e. to generate each sample the ADC is read 64 times and averaged, giving an extra 3 bits of resolution.  

## Digital inputs

The two BNC digital inputs are compatible with 5V or 3.3V logic and are typically used to acquire sync pulses or timestamps, e.g. generated by behavioural hardware.  The digital inputs connect directly to pins on the microcontroller.

## LED drivers

The aquisition board has two constant current LED driver circuits which are controlled by the Micropython's digtal to analog converters (DACs), allowing the LED current to be adjusted between 0 - 100mA.  The LED driver outputs are M8 connectors that are compatible with either [Doric](http://doriclenses.com/life-sciences/led-modules/783-connectorized-led.html) or [Thor Labs](https://www.thorlabs.com/newgrouppage9.cfm?objectgroup_id=5206) connectorized LEDs.  

The LED driver circuits are voltage controlled current sinks in which an op amp adjusts the voltage at an MOSFET's gate to bring the voltage across a sense resistor in series with the LED into agreement with the control voltage from the microcontroller.  A resistor between the 3.3V rail and the inverting input of the op amp ensures the MOSFET is fully turned off when the control voltage is 0.  The LED current can be monitored by measuring the voltage between the *SENSE1* or *SENSE2* and *GND* connections on the acquisition board, which gives the voltage across the 4.7 ohm sense resistors in series with the respective LEDs.

# Assembly instructions

**Acquisition board**

The acquisition board can be purchased from OEPS for â‚¬350 (<info@oeps.tech>) or built from components.  The design files for the acquitition board are in the [hardware repository](https://bitbucket.org/takam/pyphotometry_hardware). To assemble the board from components you will need to get the PCB printed (using either the Gerber or Eagle files) and order the electronic components listed in the BOM (Farnell part numbers are provided).
 
Assembling the acquisition board requires both surface mount and through hole soldering.  The surface mount soldering can be done either using a reflow oven or hand soldering.  Hand soldering of surface mount components requires a bit of practice but there are lots of [tutorials](https://www.google.co.uk/search?q=surface+mount+soldering+tutorial) online.  Solder all the surface mount components before soldering the through hole components as once the through hole components are in place they will get in the way.  The micropython board is attached to the acqusition board using the male and female 16 way headers.  First solder the female headers onto the micropython board, then insert the male headers into the female headers, mount the micropython on the acquisition board and solder the male headers.

**Optical components**

To make a complete photometetry system the acquisition board needs to be paired with LEDs, photorecievers, filter cubes and other optical components.  A [parts list](../resources/optical-components.md) for a set of additional components that can be used with the aquisition board for green/red two colour experiments (e.g. GCaMP/TdTomato) is provided in the resources section of the docs, and as a Excel file in the hardware repository.

If you plan to use the time-division multiplexed illumination mode, the maximum sampling rate that can be  achieved without crosstalk between the signals will depend on the bandwidth of the photoreievers.  We use [Newport 2151](https://www.newport.com/p/2151) photorecievers in DC coupled mode, which have a bandwidth of 0-750 Hz.

The optical components for the red/green system are positioned and connected as indicated below:

![pyPhotometry GUI](../media/optical_parts_diagram.jpg)
 
 To assemble the system:

Attach the minicube to the optical breadboard using the clamp (CL3/M) and 45mm M6 bolts.
    
Attach the acquisition board to the breadboard using the M6-M3 screw adaptors, M3 spacers and 10mm M3 screws.  Screw the adaptors into the breadboard, then attach the acquisition board with the spacers between the board and the adaptors.

Attach the Newport photorecievers to the breadboard using the pillars (TRP14/M), clamping forks (MSC2) and 12mm M6 bolts.

Attach the LEDs to the breadboard using the 12mm M6 bolts.

Connect the photorecievers to the minicube using the 30cm, 600um core 0.48NA optic fibers  (MFP_600/630/LWMJ-0.48_0.3m_FCM-FCM)

Connect the LEDs to the minicube using the 30cm, 200um core 0.48NA optic fibers (MFP_200/220/LWMJ-0.48_0.3m_FCM-FCM)

Connect the photorecivers to the acquisition board analog inputs using the 30cm BNC cables.

Connect the LEDs to the acquisition board LED outputs using their built in cables.  It is not necessary to connect the power supplies for the LED cooling fans as the maximum current output by the acquisition board is only 10% of the LEDs rated current.

Connect the pigtailed rotary joint to the sample port of the minicube and connect the fiber patchcord to the rotary joint using the FC-FC adapter.